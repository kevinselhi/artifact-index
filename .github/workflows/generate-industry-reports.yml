name: Generate Industry Reports

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      results_per_sector:
        description: 'Number of search results per sector (default: 10)'
        required: false
        default: '10'
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: write

jobs:
  generate-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate industry reports
        id: generate
        continue-on-error: true
        env:
          YOU_API_KEY: ${{ secrets.YOU_API_KEY }}
          RESULTS_PER_SECTOR: ${{ github.event.inputs.results_per_sector || '10' }}
        run: |
          echo "Starting industry reports generation..."
          echo "API Key configured: ${YOU_API_KEY:0:10}...${YOU_API_KEY: -5}"
          echo "Results per sector: $RESULTS_PER_SECTOR"
          echo ""

          # Run the generate script
          node generate-industry-reports.js

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: industry-reports
          path: dashboard/data/industry-reports.json

      - name: Check results quality
        id: check_results
        if: always()
        run: |
          if [ ! -f dashboard/data/industry-reports.json ]; then
            echo "::error::No results file generated"
            exit 1
          fi

          # Count successes
          TOTAL=$(jq '.metadata.totalSectors' dashboard/data/industry-reports.json)
          PROCESSED=$(jq '.metadata.processedSectors' dashboard/data/industry-reports.json)
          TOTAL_RESULTS=$(jq '[.sectors[].totalResults] | add' dashboard/data/industry-reports.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "processed=$PROCESSED" >> $GITHUB_OUTPUT
          echo "results=$TOTAL_RESULTS" >> $GITHUB_OUTPUT

          echo "Industry Reports: $PROCESSED sectors processed, $TOTAL_RESULTS total insights"

          # Fail if no sectors processed
          if [ "$PROCESSED" -eq 0 ]; then
            echo "::error::No sectors processed! Check API key and endpoint."
            exit 1
          fi

      - name: Create commit with results
        if: steps.check_results.outcome == 'success'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add dashboard/data/industry-reports.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            PROCESSED=${{ steps.check_results.outputs.processed }}
            RESULTS=${{ steps.check_results.outputs.results }}

            git commit -m "Update industry reports ($PROCESSED sectors, $RESULTS insights)" \
                       -m "Automated generation via GitHub Actions" \
                       -m "- Sectors analyzed: $PROCESSED" \
                       -m "- Total insights: $RESULTS" \
                       -m "- Categories: AI Impact, Industry Trends, Market Analysis"
            git push
            echo "Industry reports committed and pushed!"
          fi

      - name: Summary
        if: always()
        run: |
          if [ -f dashboard/data/industry-reports.json ]; then
            echo "## Industry Reports Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.metadata.totalSectors' dashboard/data/industry-reports.json)
            PROCESSED=$(jq '.metadata.processedSectors' dashboard/data/industry-reports.json)
            TOTAL_RESULTS=$(jq '[.sectors[].totalResults] | add' dashboard/data/industry-reports.json)
            LAST_UPDATED=$(jq -r '.metadata.lastUpdated' dashboard/data/industry-reports.json)

            echo "- **Sectors Analyzed:** $PROCESSED / $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Insights:** $TOTAL_RESULTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Last Updated:** $LAST_UPDATED" >> $GITHUB_STEP_SUMMARY
            echo "- **Categories:** AI Impact, Industry Trends, Market Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### Query Types" >> $GITHUB_STEP_SUMMARY
            echo "| Type | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| ai_impact | AI automation impact on professional services |" >> $GITHUB_STEP_SUMMARY
            echo "| industry_trends | Industry innovation and trends |" >> $GITHUB_STEP_SUMMARY
            echo "| market_analysis | Market analysis and insights |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "Industry reports committed to repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "## No Results Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The generate script did not create any output file." >> $GITHUB_STEP_SUMMARY
          fi
