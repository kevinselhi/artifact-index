name: Fetch You.com Search Results

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      batch_size:
        description: 'Number of artifacts to fetch (default: all 227)'
        required: false
        default: '227'
      results_per_artifact:
        description: 'Number of search results per artifact'
        required: false
        default: '3'

jobs:
  fetch-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch You.com results
        id: fetch
        continue-on-error: true
        env:
          YOU_API_KEY: ${{ secrets.YOU_API_KEY }}
          MAX_ARTIFACTS: ${{ github.event.inputs.batch_size || '227' }}
          RESULTS_PER_ARTIFACT: ${{ github.event.inputs.results_per_artifact || '3' }}
        run: |
          echo "Starting batch fetch..."
          echo "API Key configured: ${YOU_API_KEY:0:10}...${YOU_API_KEY: -5}"
          echo "Max artifacts: $MAX_ARTIFACTS"
          echo "Results per artifact: $RESULTS_PER_ARTIFACT"
          echo ""

          # Run the fetch script (allow to continue even if exits with error)
          node fetch-you-results.js

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: you-search-results
          path: dashboard/data/you-search-results.json

      - name: Check results quality
        id: check_results
        if: always()
        run: |
          if [ ! -f dashboard/data/you-search-results.json ]; then
            echo "::error::No results file generated"
            exit 1
          fi

          # Count successes and failures
          TOTAL=$(jq '.metadata.processedArtifacts' dashboard/data/you-search-results.json)
          SUCCESS=$(jq '[.artifacts[] | select(.results | length > 0)] | length' dashboard/data/you-search-results.json)
          ERRORS=$(jq '[.artifacts[] | select(.error != null or (.results | length == 0))] | length' dashboard/data/you-search-results.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Results: $SUCCESS successful, $ERRORS errors out of $TOTAL processed"

          # Fail if NO successful fetches
          if [ "$SUCCESS" -eq 0 ]; then
            echo "::error::All fetches failed! Check API key and endpoint."
            exit 1
          fi

          # Warn if >50% failures but continue
          if [ "$ERRORS" -gt "$SUCCESS" ]; then
            echo "::warning::More than 50% of fetches failed ($ERRORS failures vs $SUCCESS successes)"
          fi

      - name: Create commit with results
        if: steps.check_results.outcome == 'success'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add dashboard/data/you-search-results.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SUCCESS=${{ steps.check_results.outputs.success }}
            ERRORS=${{ steps.check_results.outputs.errors }}
            TOTAL=${{ steps.check_results.outputs.total }}

            git commit -m "Update You.com search results ($SUCCESS/$TOTAL successful)" \
                       -m "Automated fetch via GitHub Actions" \
                       -m "- Successful: $SUCCESS artifacts" \
                       -m "- Errors: $ERRORS artifacts" \
                       -m "- Total processed: $TOTAL"
            git push
            echo "âœ… Results committed and pushed!"
          fi

      - name: Summary
        if: always()
        run: |
          if [ -f dashboard/data/you-search-results.json ]; then
            echo "## Fetch Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.metadata.processedArtifacts' dashboard/data/you-search-results.json)
            SUCCESS=$(jq '[.artifacts[] | select(.results | length > 0)] | length' dashboard/data/you-search-results.json)
            ERRORS=$(jq '[.artifacts[] | select(.error != null or (.results | length == 0))] | length' dashboard/data/you-search-results.json)

            echo "- **Total Processed:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Successful:** $SUCCESS âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS âŒ" >> $GITHUB_STEP_SUMMARY
            echo "- **File:** \`dashboard/data/you-search-results.json\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$SUCCESS" -gt 0 ]; then
              echo "âœ… Results committed to repository" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ No successful fetches - check API key and endpoint" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ No Results Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The fetch script did not create any output file." >> $GITHUB_STEP_SUMMARY
          fi
